{"version":3,"sources":["../../mol.jam.js","-","mol.ts","../fiber.ts"],"names":[],"mappings":"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","file":"node.js","sourcesContent":[null,null,"declare namespace $ {}\nexport = $\n\n","var requestIdleCallback : ( handler : ()=> void )=> number = requestIdleCallback || setTimeout\n\nnamespace $ {\n\n\texport const $mol_fiber_wait = new class $mol_fiber_wait {}\n\t\n\texport class $mol_fiber< Result = any > {\n\n\t\tstatic quant = 8\n\n\t\tstatic current : $mol_fiber\n\t\t\n\t\tstatic scheduled = 0\n\t\tstatic deadline = 0\n\n\t\tstatic tick() {\n\n\t\t\t$mol_fiber.scheduled = 0\n\t\t\t$mol_fiber.deadline = Date.now() + $mol_fiber.quant\n\t\n\t\t\tif( $mol_fiber.queue.length == 0 ) return\n\t\n\t\t\twhile( true ) {\n\t\t\t\t\n\t\t\t\tconst fiber = $mol_fiber.queue.shift()\n\t\t\t\tif( !fiber ) break\n\t\n\t\t\t\tconst res = fiber.start()\n\t\n\t\t\t\tif( res instanceof $mol_fiber_wait.constructor ) break\n\t\t\t}\n\t\t}\n\n\t\tstatic schedule() {\n\t\t\tif( $mol_fiber.scheduled ) return\n\n\t\t\t$mol_fiber.scheduled = requestIdleCallback( $mol_fiber.tick )\n\t\t}\n\n\t\tstatic queue = [] as $mol_fiber[]\n\n\t\tconstructor(\n\t\t\treadonly handler : ()=> Result ,\n\t\t\treadonly slave : $mol_fiber = undefined ,\n\t\t) {\n\t\t\tif( slave ) slave.master = this\n\t\t}\n\n\t\tdestructor() {\n\t\t\tif( !this.masters ) return\n\n\t\t\tfor( let master of this.masters ) {\n\t\t\t\tmaster.destructor()\n\t\t\t}\n\t\t\t\n\t\t\tthis.masters = null\n\n\t\t\tif( this.abort ) this.abort()\n\t\t}\n\n\t\tabort : ()=> void\n\n\t\tmasters = [] as $mol_fiber[]\n\t\tcursor = -1\n\n\t\terror : Error = undefined\n\t\tresult : Result = undefined\n\n\t\tschedule() {\n\t\t\tif( !this.masters ) debugger\n\n\t\t\t$mol_fiber.queue.push( this )\n\t\t\t$mol_fiber.schedule()\n\t\t}\n\n\t\tcomplete() {\n\t\t\tthis.abort = null\n\t\t\tthis.destructor()\n\n\t\t\tif( !this.slave ) return\n\t\t\tif( $mol_fiber.current ) return\n\t\t\t\n\t\t\tthis.slave.schedule()\n\t\t}\n\n\t\tdone( result : Result ) {\n\t\t\tif( !this.masters ) return\n\n\t\t\tthis.result = result\n\t\t\tthis.complete()\n\t\t\t\n\t\t\treturn result\n\t\t}\n\n\t\tfail( error : Error ) {\n\t\t\tif( !this.masters ) return\n\t\t\t\n\t\t\tthis.error = error\n\t\t\tthis.complete()\n\t\t\t\n\t\t\treturn error\n\t\t}\n\n\t\tlimit() {\n\t\t\tif( Date.now() <= $mol_fiber.deadline ) return\n\n\t\t\tif( !$mol_fiber.current && $mol_fiber.queue.length === 0 ) {\n\t\t\t\t$mol_fiber.deadline = Date.now() + $mol_fiber.quant\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tthis.schedule()\n\t\t\tthrow $mol_fiber_wait\n\t\t}\n\n\t\tstart() : Result {\n\n\t\t\tconst slave = $mol_fiber.current\n\t\t\tif( slave ) slave.step()\n\t\t\t\n\t\t\tif( !this.masters ) {\n\t\t\t\tif( this.error ) throw this.error\n\t\t\t\treturn this.result\n\t\t\t}\n\t\n\t\t\tthis.cursor = 0\n\n\t\t\ttry {\n\t\t\t\t\n\t\t\t\tthis.limit()\n\n\t\t\t\t$mol_fiber.current = this\n\t\t\t\tconst result = this.handler()\n\t\t\t\t$mol_fiber.current = slave\n\n\t\t\t\treturn this.done( result )\n\n\t\t\t} catch( error ) {\n\n\t\t\t\t$mol_fiber.current = slave\n\n\t\t\t\tif( error !== $mol_fiber_wait ) this.fail( error )\n\t\t\t\t\n\t\t\t\tif( slave ) throw error\n\t\t\t\t\n\t\t\t\tif( error !== $mol_fiber_wait ) throw error\n\t\t\t\treturn new Proxy( error , { get() { throw error } } )\n\n\t\t\t}\t\n\n\t\t}\n\n\t\tstep() {\n\t\t\t++ this.cursor\n\t\t}\n\n\t\tget master() {\n\t\t\treturn this.masters[ this.cursor ]\n\t\t}\n\t\tset master( next : $mol_fiber ) {\n\t\t\tthis.masters[ this.cursor ] = next\n\t\t}\n\n\t\ttoString() {\n\t\t\tif( !this.slave ) return ''\n\t\t\treturn this.slave + '/' + this.slave.masters.indexOf( this )\n\t\t}\n\n\t}\n\n}\n"]}